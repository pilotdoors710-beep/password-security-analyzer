import json
import hashlib
import os
import time 
FILE_NAME = "users.json"

def load_users():
    if os.path.exists(FILE_NAME):
        with open(FILE_NAME, "r") as f:
            data = json.load(f)
            # convert hex back to bytes
            for user in data:
                data[user]["salt"] = bytes.fromhex(data[user]["salt"])
                data[user]["hashed"] = bytes.fromhex(data[user]["hashed"])
            return data
    return {}

def save_users():
    data = {}
    for user in users:
        data[user] = {
            "salt": users[user]["salt"].hex(),
            "hashed": users[user]["hashed"].hex(),
            "last_login": users[user]["last_login"],
            "incorrect": users[user]["incorrect"],
            "lock_until": users[user]["lock_until"]
        }
    with open(FILE_NAME, "w") as f:
        json.dump(data, f, indent=4)


users=load_users()

def hash_password(password, salt):
    return hashlib.pbkdf2_hmac(
        'sha256', password.encode(), salt, 100_000)
def register():
    user=input("Enter your username")
    if user in users:
        print("âŒ User already exists")
        return  
    password=input("Enter your password")
    length=len(password)
    if length<=8:
        print("Your password is too short. It must be 8 letters or more.")
    elif length>8 and length<=12:
        print("Make your password a bit longer")
    else:
        print("Good length")
    upper=False
    lower=False
    number=False
    symbol=False
    for char in password:
        if char.isupper():
            upper=True  
        elif char.islower():
            lower=True
        elif char.isdigit():
            number=True
        else:   
            symbol=True


    score=0
    if length<=12 and length>8:
        score=score+0.5
    if length>12:
        score=score+1

    if upper:
        score=score+1
    if lower:
        score=score+1
    if number:
        score=score+1
    if symbol:
        score=score+1
    if length>=8:
        score=score+1


    

    print("Password Analysis:")

    print("Uppercase letter:", "âœ…" if upper else "âŒ Add at least one uppercase letter (Aâ€“Z)")
    print("Lowercase letter:", "âœ…" if lower else "âŒ Add at least one lowercase letter (aâ€“z)")
    print("Number:", "âœ…" if number else "âŒ Add at least one number (0â€“9)")
    print("Symbol:", "âœ…" if symbol else "âŒ Add at least one symbol (!, @, #, etc.)")

    print("Your password is a ",score,"/6")

    salt=os.urandom(16)
    hashpassword = hash_password(password,salt)
    users[user]={
        "salt": salt,
        "hashed": hashpassword,
        "last_login": None,
        "incorrect": 0,
        "lock_until": None
        }
    save_users()

    print("\nğŸ§‚ Salt (stored):")
    print(salt.hex())

    print("\nğŸ”’ PBKDF2-HMAC-SHA256 Hashed Password:")
    print(hashpassword)

def login():
    loginuser = input("Enter your username: ")
    if loginuser not in users:
        print("âŒ User not found")
        return

    account = users[loginuser]

    if account["lock_until"] and time.time() < account["lock_until"]:
        remaining = int(account["lock_until"] - time.time())
        print("Account locked. Try again in ",remaining,"seconds")
        return

    while account["incorrect"] < 3:
        password = input("Enter your password: ")
        login_hash = hash_password(password, account["salt"])

        if login_hash == account["hashed"]:
            print("ğŸ‰ Login successful")

            if account["last_login"]:
                print("Last login:", account["last_login"])
            else:
                print("ğŸ•’ First login")

            account["last_login"] = time.ctime()
            account["incorrect"] = 0
            account["lock_until"] = None
            return
            save_users()
        else:
            account["incorrect"] += 1
            print("âŒ Incorrect password")

    account["lock_until"] = time.time() + 30
    print("ğŸ”’ Too many attempts. Locked for 30 seconds")

def reset_password():
    user = input("Enter your username: ")
    if user not in users:
        print("âŒ User not found")
        return

    account = users[user]

    old_password = input("Enter OLD password: ")
    if hash_password(old_password, account["salt"]) != account["hashed"]:
        print("âŒ Old password incorrect")
        return

    new_password = input("Enter NEW password: ")
    new_salt = os.urandom(16)
    new_hash = hash_password(new_password, new_salt)

    account["salt"] = new_salt
    account["hashed"] = new_hash
    account["incorrect"] = 0
    account["lock_until"] = None

    print("ğŸ” Password reset successful")

while True:
    print("\nMain Menu")
    print("1. Register")	
    print("2. Login")
    print("3. Reset password")\
              
    print("4. Quit")

    choice = input("Enter choice: ")

    if choice == "1":
        register()
    elif choice == "2":
        login()
    elif choice == "3":
        reset_password()
    elif choice == "4":
        print("Peace gng ğŸ‘‹")
        break
    else:
        print("âŒ Invalid option")